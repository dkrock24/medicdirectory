{% extends "Layout/base_emr/_clients_base.html.twig" %}

{% block title_page %}
        EMR || Nueva Cita
{% endblock %}

{% block breadcrumb %}
    {{ include('EmrBundle:cita:_breadcrumb.html.twig' )  }}
{% endblock %} 

{% block submenutop %}
    {{ include('EmrBundle:cita:_submenu.html.twig' )  }}
{% endblock %} 

{% block body %}
    <style>
        /*
        #calendar {
		max-width: 900px;
		margin: 0 auto;
        }
        */
    
    

    </style>
    
    <div class="page-header-content">
        <div class="page-title">
            <h4>
                <i class="fa fa-info-circle position-left"></i>
                <span class="text-semibold">Home</span> - Crear cita

                <small class="display-block">Seleccione el horario que desea reservar para la cita</small></h4>
            <a class="heading-elements-toggle"><i class="icon-more"></i></a><a class="heading-elements-toggle"><i class="icon-more"></i></a></div>

        <div class="heading-elements">
            <div class="heading-btn-group">

                <a href="#" class="btn btn-link btn-float has-text"><i class="icon-bars-alt text-primary"></i><span>Statistics</span></a>
                <a href="#" class="btn btn-link btn-float has-text"><i class="icon-calculator text-primary"></i> <span>Invoices</span></a>
                <a href="#" class="btn btn-link btn-float has-text"><i class="icon-calendar5 text-primary"></i> <span>Schedule</span></a>

            </div>
        </div>

    </div>
    <div class="row">
        <div class="col-lg-8">
            <!-- Agenda view -->
				<div class="panel panel-flat">
					<div class="panel-heading">
						<h5 class="panel-title">Calendario</h5>
						<div class="heading-elements">
							<ul class="icons-list">
		                		<li><a data-action="collapse"></a></li>
		                		<li><a data-action="reload"></a></li>
		                		<li><a data-action="close"></a></li>
		                	</ul>
	                	</div>
					</div>
					
					<div class="panel-body">
                        <div class="alert alert-info alert-styled-left alert-arrow-left alert-component">
                            Calendario para reservaciones de citas
                        </div>
                        <div id="calendar"></div>
					</div>
				</div>
				<!-- agenda view -->
        </div>
        <div class="col-lg-4">
            {{ include('EmrBundle:paciente:_search.html.twig' )  }}       
        </div>
    </div>
            
    <!-- Modal -->
    <!---
    <div class="modal fade" id="calendarModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">Modal title</h4>
          </div>
          <div class="modal-body">
              <div id="modalTitle"></div>
              <div id="modalByWhen"></div>
              <div id="eventId"></div>
              
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="save">Save changes</button>
          </div>
        </div>
      </div>
    </div>  
    -->
    <!-- Modal to Event Details -->

<!-- Modal  to Add Event -->

<div id="createEventModal" class="modal fade" role="dialog">

    <div class="modal-dialog">
        <!-- Modal content-->

        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Agregar Cita</h4>
            </div>

            <div class="modal-body">
                <div class="control-group">
                    <label class="control-label" for="inputPatient">Cita:</label>
                    <div class="field desc">
                        <input class="form-control" id="title" name="title" placeholder="Event" type="text" value="">
                    </div>
                </div>

                <input type="hidden" id="startTime"/>
                <input type="hidden" id="endTime"/>

                <div class="control-group">
                    <label class="control-label" for="when">Cuando:</label>
                    <div class="controls controls-row" id="when" style="margin-top:5px;">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" data-dismiss="modal" aria-hidden="true">Cerrar</button>
                <button type="submit" class="btn btn-primary" id="submitButton">Guardar</button>
            </div>
        </div>
    </div>
</div>



<!-- Modal to Event Details -->

<div id="calendarModal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Detalles de la cita</h4>
            </div>

            <div id="modalBody" class="modal-body">
                <h4 id="modalTitle" class="modal-title"></h4>
                <div id="modalWhen" style="margin-top:5px;"></div>
            </div>

            <input type="hidden" id="eventID"/>
            <div class="modal-footer">
                <button class="btn"  data-dismiss="modal" aria-hidden="true">Cerrar</button>
                <button type="submit" class="btn btn-danger" id="deleteButton">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<!--Modal-->

<!--Modal-->
{% endblock %}


{% block codejs %}
    <script>
        $(document).on("ready", function(){
            // Add events
            // ------------------------------
            var initialLocaleCode = 'es-do';
    
            // Default events
            var events = [
                {
                    title: 'All Day Event',
                    start: '2017-04-29'
                },
                {
                    title: 'Long Event',
                    start: '2014-11-07',
                    end: '2014-11-10'
                },
                {
                    id: 999,
                    title: 'Repeating Event',
                    start: '2014-11-09T16:00:00'
                },
                {
                    id: 999,
                    title: 'Repeating Event',
                    start: '2014-11-16T16:00:00'
                },
                {
					title: 'Lunch',
					start: '2017-04-28T12:30:00'
				},

                {
					title: 'Meeting',
					start: '2017-04-27T10:00:00',
					end: '2017-04-27T10:30:00'
				},
                {
					title: 'Meeting 2',
					start: '2017-04-28T10:00:00',
					end: '2017-04-28T11:00:00'
				},
                {
                    title: 'Lunch',
                    start: '2014-11-12T12:00:00'
                },
                {
                    title: 'Meeting',
                    start: '2014-11-12T14:30:00'
                },
                {
                    title: 'Happy Hour',
                    start: '2014-11-12T17:30:00'
                },
                {
                    title: 'Dinner',
                    start: '2014-11-12T20:00:00'
                },
                {
                    title: 'Birthday Party',
                    start: '2014-11-13T07:00:00'
                },
                {
                    title: 'Click for Google',
                    url: 'http://google.com/',
                    start: '2014-11-28'
                }
            ];


            // Event colors
            var eventColors = [
                {
                    title: 'All Day Event',
                    start: '2014-11-01',
                        color: '#EF5350'
                    },
                    {
                        title: 'Long Event',
                        start: '2014-11-07',
                        end: '2014-11-10',
                        color: '#26A69A'
                    },
                    {
                                    id: 999,
                                    title: 'Repeating Event',
                                    start: '2014-11-09T16:00:00',
                                    color: '#26A69A'
                    },
                    {
                                    id: 999,
                                    title: 'Repeating Event',
                                    start: '2014-11-16T16:00:00',
                                    color: '#5C6BC0'
                    },
                    {
                                    title: 'Conference',
                                    start: '2014-11-11',
                                    end: '2014-11-13',
                                    color: '#546E7A'
                    },
                    {
                                    title: 'Meeting',
                                    start: '2014-11-12T10:30:00',
                                    end: '2014-11-12T12:30:00',
                                    color: '#546E7A'
                    },
                    {
                                    title: 'Lunch',
                                    start: '2014-11-12T12:00:00',
									color: '#546E7A'
					},
					{
									title: 'Meeting',
									start: '2014-11-12T14:30:00',
									color: '#546E7A'
					},
					{
									title: 'Happy Hour',
									start: '2014-11-12T17:30:00',
									color: '#546E7A'
					},
					{
									title: 'Dinner',
									start: '2014-11-12T20:00:00',
									color: '#546E7A'
					},
					{
						title: 'Birthday Party',
						start: '2014-11-13T07:00:00',
						color: '#546E7A'
                    },
					{
									title: 'Click for Google',
									url: 'http://google.com/',
									start: '2014-11-28',
									color: '#FF7043'
					}
				];


            // Event background colors
            var eventBackgroundColors = [
                    {
                        title: 'All Day Event',
                        start: '2014-11-01'
                    },
                    {
                        title: 'Long Event',
                        start: '2014-11-07',
                        end: '2014-11-10',
                        color: '#DCEDC8',
                        rendering: 'background'
                    },
                    {
                        id: 999,
                        title: 'Repeating Event',
                        start: '2014-11-06T16:00:00'
                    },
                    {
                        id: 999,
                        title: 'Repeating Event',
                        start: '2014-11-16T16:00:00'
                    },
                    {
                        title: 'Conference',
                        start: '2014-11-11',
                        end: '2014-11-13'
                    },
                    {
                        title: 'Meeting',
                        start: '2014-11-12T10:30:00',
                        end: '2014-11-12T12:30:00'
                    },
                    {
                        title: 'Lunch',
                        start: '2014-11-12T12:00:00'
                    },
                    {
                        title: 'Happy Hour',
                        start: '2014-11-12T17:30:00'
                    },
                    {
                        title: 'Vacation',
                        start: '2014-11-27',
                        end: '2014-11-30',
                        color: '#FFCCBC',
                        rendering: 'background'
                    }
            ];



            // Initialization
            // ------------------------------
            // Agenda view
            $('#calendar').fullCalendar({
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'month,agendaWeek,agendaDay'
                },
                //default: 30,
                locale: initialLocaleCode,
                //defaultDate: '2017-04-29',
                defaultView: 'agendaWeek',
                editable: true,
                eventLimit: true, // allow "more" link when too many events
                navLinks: true, // can click day/week names to navigate views
                selectable: true,
                selectHelper: true,
                //events: events,
                events: "{{ path('cita_valida') }}?view=1",
                eventClick:  function(event, jsEvent, view) {  // when some one click on any event

                    endtime = $.fullCalendar.moment(event.end).format("h:mm");
                    starttime = $.fullCalendar.moment(event.start).format("dddd, MMMM Do YYYY, h:mm");
                    var mywhen = starttime + " – " + endtime;
                    $("#modalTitle").html(event.title);
                    $("#modalWhen").text(mywhen);
                    $("#eventID").val(event.id);
                    $("#calendarModal").modal({backdrop: 'static', keyboard: false});
                },
                select: function(start, end, jsEvent) {  // click on empty time slot
                    endtime = $.fullCalendar.moment(end).format("h:mm");
                    starttime = $.fullCalendar.moment(start).format("dddd, MMMM Do YYYY, h:mm");
                    var mywhen = starttime + " – " + endtime;
                    start = moment(start).format();
                    end = moment(end).format();
                    $("#createEventModal #startTime").val(start);
                    $("#createEventModal #endTime").val(end);
                    $("#createEventModal #when").text(mywhen);
                    //$("#createEventModal").modal("toggle");
                    $("#createEventModal").modal({backdrop: 'static', keyboard: false});

                },
                eventDrop: function(event, delta){ // event drag and drop
                    $.ajax({
                        url: "{{ path('cita_valida')}}",
                        data: "action=update&title="+event.title+"&start="+moment(event.start).format()+"&end="+moment(event.end).format()+"&id="+event.id ,
                        type: "POST",
                        success: function(json) {
                            //alert(json);
                        }
                    });
                },
                eventResize: function(event) {  // resize to increase or decrease time of event
                    $.ajax({
                        url: "{{ path('cita_valida') }}",
                        data: "action=update&title="+event.title+"&start="+moment(event.start).format()+"&end="+moment(event.end).format()+"&id="+event.id,
                        type: "POST",
                        success: function(json) {
                            //alert(json);
                        }
                    });

            }
                /*
                select: function(start, end) {
                   
                    var title = prompt('Event Title:');
                    var eventData;
                    if (title) {
                        eventData = {
                            title: title,
                            start: start,
                            end: end
                        };
                        $('#calendar').fullCalendar('renderEvent', eventData, true); // stick? = true
                    }
                    $('#calendar').fullCalendar('unselect');
                    
                },
                */
                
            });
            
            
            $("#submitButton").on("click", function(e){ // add event submit
                // We don"t want this to act as a link so cancel the link action
                e.preventDefault();
                doSubmit(); // send to form submit function
            });

       

            $("#deleteButton").on("click", function(e){ // delete event clicked
                // We don"t want this to act as a link so cancel the link action
                e.preventDefault();
                doDelete(); //send data to delete function
            });

       

       function doDelete(){  // delete event 

           $("#calendarModal").modal("hide");
           var eventID = $("#eventID").val();
           $.ajax({
               url: "{{ path('cita_valida') }}",
               data: "action=delete&id="+eventID,
               type: "POST",
               success: function(json) {
                   if(json == 1)

                        $("#calendar").fullCalendar("removeEvents",eventID);

                   else

                        return false;
               }
           });

       }

       function doSubmit(){ // add event

           $("#createEventModal").modal("hide");

           var title = $("#title").val();

           var startTime = $("#startTime").val();

           var endTime = $("#endTime").val();

           

           $.ajax({

               url: "{{ path('cita_valida') }}",

               data: "action=add&title="+title+"&start="+startTime+"&end="+endTime,

               type: "POST",

               success: function(json) {

                   $("#calendar").fullCalendar("renderEvent",
                   {
                       id: json.id,
                       title: title,
                       start: startTime,
                       end: endTime,
                   },

                   true);

               },
               error: function(json){
                  $("#calendar").fullCalendar("renderEvent",
                   {
                       id: json.id,
                       title: title,
                       start: startTime,
                       end: endTime,
                   },

                   true);
               }
           });
       }
            
            
            
        });
               
                        
    </script>
{% endblock %}    

