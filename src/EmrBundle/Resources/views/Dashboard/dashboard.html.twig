{% extends "Layout/base_emr/_clients_base.html.twig" %}

{% block title_page %}
        EMR || Bienvenido
{% endblock %}

{% block breadcrumb %}
    {{ include('EmrBundle:Dashboard:_breadcrumb.html.twig' )  }}
{% endblock %} 

{% block submenutop %}
    {{ include('EmrBundle:Dashboard:_submenu.html.twig' )  }}
{% endblock %} 

{% block body %}
    <!-- Page header -->
	<div class="page-header">
		<div class="page-header-content">
			<div class="page-title">
				<h4>
					<a href="{{ app.request.headers.get('referer') }}">
                <i class="icon-arrow-left52 position-left"></i>
                <span class="text-semibold">Regresar</span></a> - Dashboard
					<small class="display-block">Buen día, {{ userInfo.usuNombre ~ userInfo.usuSegundoNombre ~ userInfo.usuTercerNombre ~ userInfo.usuPrimerApellido ~ userInfo.usuSegundoApellido }}!</small>
				</h4>
			</div>

			<div class="heading-elements">
                {#
				<div class="heading-btn-group">
					<a href="#" class="btn btn-link btn-float has-text"><i class="icon-bars-alt text-primary"></i><span>Statistics</span></a>
					<a href="#" class="btn btn-link btn-float has-text"><i class="icon-calculator text-primary"></i> <span>Invoices</span></a>
					<a href="#" class="btn btn-link btn-float has-text"><i class="icon-calendar5 text-primary"></i> <span>Schedule</span></a>
				</div>
                #}
			</div>
		</div>
	</div>
	<!-- /page header -->


	<!-- Page container -->
	<div class="page-containerx">

		<!-- Page content -->
		<div class="page-contentx">

			<!-- Main content -->
			<div class="content-wrapperx">

                <div class="panel panel-flat">
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-lg-3 col-md-4 col-sm-4 col-xs-6">

                                {% if  profilephoto != "" %}
                                    <div style="text-align:center;"><img src="{{ image('uploads/perfil/'~profilephoto).cropResize(200,200) }}" class="img-thumbnailx" style="max-width:100% "></div>
                                {% else %}

                                    {% if userInfo.usuGenero|lower  == "m" %}

                                        {% if roles.3 is defined %}
                                             <div  style="text-align:center"><img src="{{ asset('bundles/admin/img/asistente-hombre.png') }}" class="img-thumbnailx" style="max-width:80% "></div>
                                        {% else %}
                                             <div  style="text-align:center"><img src="{{ asset('bundles/admin/img/doctor.png') }}" class="img-thumbnailx" style="max-width:80% "></div>
                                        {% endif %} 

                                    {% else %}
                                        {% if roles.3 is defined %}
                                             <div  style="text-align:center"><img src="{{ asset('bundles/admin/img/asistente-mujer.png') }}" class="img-thumbnailx" style="max-width:80% "></div>
                                        {% else %}
                                             <div  style="text-align:center"><img src="{{ asset('bundles/admin/img/doctora.png') }}" class="img-thumbnailx" style="max-width:80% "></div>
                                        {% endif %} 

                                    {% endif %}

                                {% endif %}
                                <hr>
                                <h4><i class="icon-bubbles4"></i> Mensajes sin Leer <span class="badge bg-warning-400 unread">{{ unReadMessage }}</span> </h4>
                            </div>
                            <div class="col-lg-9 col-md-8 col-sm-8 col-xs-6">
                                <!-- Quick stats boxes -->
                                
                                <!-- /quick stats boxes -->
                                
                                
                                <div class="row">
                                    <div class="col-lg-6">
                                        {% if doctorsList|length > 0 and roles.3 is defined %}
                                                <label>Lista de doctores disponibles</label>
                                                <select id="doctorsList" class="select form-control">
                                                    <option value="">.::Seleccione un doctor::.</option>
                                                    {% for doctor in doctorsList %}
                                                        <option value="{{ doctor.cliUsuUsu.usuId }}">
                                                            {{ doctor.cliUsuTitulo }} 
                                                            {{ doctor.cliUsuUsu.usuNombre|capitalize~" "~doctor.cliUsuUsu.usuSegundoNombre|capitalize~" "~doctor.cliUsuUsu.usuTercerNombre|capitalize~" "~doctor.cliUsuUsu.usuPrimerApellido|capitalize~" "~doctor.cliUsuUsu.usuSegundoApellido|capitalize }}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                                <hr>
                                            {% endif %}
                                        <div class="table-responsivex" id="result_appointment">
                                                
                                            {% if appointments|length > 0 %}
                                                <table class="table text-nowrap" id="table_result_appointment">
                                                    <thead>
                                                        <tr>
                                                            <th>
                                                                {% if roles.3 is defined %}
                                                                    Agenda (Doctor)
                                                                {% else %}
                                                                    Mi agenda de Hoy
                                                                {% endif %}    
                                                            </th>
                                                            <th>Hora</th>
                                                            <th>Estatus</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for appointment in appointments %}
                                                            <tr>
                                                                <td>
                                                                    {#
                                                                    <div class="media-left media-middle">
                                                                        {% if( appointment.pac_id != "" ) %}
                                                                        <a href="{{ path('consulta_new',{'id':appointment.pac_id,'cm':appointment.id}) }}" class="btn bg-primary-400  btn-xs" data-toggle="tooltip" data-placement="top" title="Ir a la Consulta">
                                                                            <span class="letter-iconx">Procesar</span>
                                                                        </a>
                                                                        {% endif %}
                                                                        
                                                                    </div>
                                                                    #}
                                                                    <div class="media-body">
                                                                        <div class="media-heading">
                                                                            {% if roles.3 is defined %}
                                                                                <span  class="letter-icon-title">{{ appointment.pac_nombre|capitalize ~" "~ appointment.pac_seg_nombre|capitalize ~" "~ appointment.pac_apellido|capitalize ~" "~ appointment.pac_seg_apellido|capitalize }}</span>
                                                                            {% else %}
                                                                                {% if appointment.pac_id is defined and appointment.pac_id > 0 %}
                                                                                    <a href="{{ path('consulta_new',{'id':appointment.pac_id,'cm':appointment.id}) }}" class="letter-icon-title" data-toggle="tooltip" data-placement="top" title="Procesar Consulta">{{ appointment.pac_nombre|capitalize ~" "~ appointment.pac_seg_nombre|capitalize ~" "~ appointment.pac_apellido|capitalize ~" "~ appointment.pac_seg_apellido|capitalize }}</a>
                                                                                {% else %}
                                                                                    <span  class="letter-icon-title">{{ appointment.pac_nombre|capitalize ~" "~ appointment.pac_seg_nombre|capitalize ~" "~ appointment.pac_apellido|capitalize ~" "~ appointment.pac_seg_apellido|capitalize }}</span>
                                                                                {% endif %}    
                                                                            {% endif %}    
                                                                            
                                                                        </div>

                                                                        <div class="text-muted text-size-small"><i class="icon-checkmark3 text-size-mini position-left"></i> 
                                                                            {# 
                                                                            //Events type
                                                                                //1 = Cita Médica
                                                                                //2 = Evento Personal
                                                                                //3 = Ausente
                                                                                //4 = Receso
                                                                                //5 = Otros
                                                                            #}
                                                                            {% if appointment.tipo_evento  == 1 %}
                                                                                Cita Médica
                                                                            {% elseif appointment.tipo_evento == 2 %}
                                                                                Evento Personal
                                                                            {% elseif appointment.tipo_evento == 3 %}
                                                                                Ausente
                                                                            {% elseif appointment.tipo_evento == 4 %}
                                                                                Receso
                                                                            {% else %}
                                                                                Otros
                                                                            {% endif %}    
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <span class="text-muted text-size-small">{{ appointment.start}}</span>
                                                                </td>
                                                                <td>
                                                                    <h6 class="text-semibold no-margin">
                                                                        {# 
                                                                            p=pendiente, a=anulada, c=curso, t=terminada
                                                                        #}
                                                                        {% if appointment.tipo_evento == 1 %}
                                                                            {% if appointment.age_estado == "p" %}
                                                                                Pendiente
                                                                            {% elseif appointment.age_estado == "a" %}
                                                                                Anulada
                                                                            {% elseif appointment.age_estado == "c" %}
                                                                                En curso
                                                                            {% elseif appointment.age_estado == "t" %}
                                                                                Finalizada
                                                                            {% endif %}    
                                                                        {% endif %}
                                                                    </h6>
                                                                </td>
                                                            </tr>
                                                        {% endfor %}    
                                                    </tbody>
                                                </table>
                                            {% else %}
                                                <div class="alert alert-danger alert-styled-left alert-arrow-left alert-component">
                                                    {% if roles.3 is defined %}
                                                        Es necesario seleccionar un doctor para ver su agenda
                                                    {% else %}
                                                        No hay citas/eventos creados para la fecha <strong>{{ "now"|date("Y-m-d") }}</strong>
                                                    {% endif %}    
                                                   
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="text-left"><a href="{{ path('agenda_new') }}?d={{ userInfo.usuId}}" class="btn bg-teal-400 btn-sm"><i class="fa fa-calendar"></i> Ver agenda completa</a><hr></div>
                                    </div>
                                    <div class="col-lg-6">
                                        <div id="datepickerSimple"></div>
                                        <hr>
                                        <div class="row">

                                            <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">

                                                <!-- Members online -->
                                                <div class="panel bg-teal-400">
                                                    <div class="panel-body">
                                                        {#
                                                        <div class="heading-elements">
                                                            <span class="heading-text badge bg-teal-800">+53,6%</span>
                                                        </div>
                                                        #}
                                                        <h5 class="no-margin"><i class="icon-coins"></i> Ingresos</h5>

                                                        {# <div class="text-muted text-size-small">489 avg</div> #}
                                                    </div>

                                                    <div class="container-fluid">
                                                        <div id="members-online"></div>
                                                    </div>
                                                </div>
                                                <!-- /members online -->


                                            </div>

                                            <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
                                                <a href="{{ path('paciente_new') }}">
                                                    <!-- Current server load -->
                                                    <div class="panel bg-success-400">
                                                        <div class="panel-body">
                                                            {#
                                                            <div class="heading-elements">
                                                                <ul class="icons-list">
                                                                    <li class="dropdown">
                                                                        <a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="icon-cog3"></i> <span class="caret"></span></a>
                                                                        <ul class="dropdown-menu dropdown-menu-right">
                                                                            <li><a href="#"><i class="icon-sync"></i> Nuevo</a></li>
                                                                            <li><a href="#"><i class="icon-list-unordered"></i> Listar</a></li>
                                                                        </ul>
                                                                    </li>
                                                                </ul>
                                                            </div>
                                                            #}
                                                            <h5 class="no-margin"><i class="fa fa-plus-square"></i> Nuevo Paciente</h5>

                                                            {# <div class="text-muted text-size-small">34.6% avg</div> #}
                                                        </div>

                                                        <div id="server-load"></div>
                                                    </div>
                                                    <!-- /current server load -->
                                                </a>

                                            </div>

                                            <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">

                                                <a href="{{ path('agenda_new') }}?d={{ userInfo.usuId}}">
                                                    <!-- Today's revenue -->
                                                    <div class="panel bg-blue-400">
                                                        <div class="panel-body">
                                                            {#
                                                            <div class="heading-elements">
                                                                <ul class="icons-list">
                                                                    <li><a data-action="reload"></a></li>
                                                                </ul>
                                                            </div>
                                                            #}
                                                            <h5 class="no-margin"><i class="fa fa-calendar"></i> Nueva Cita</h5>

                                                            {# <div class="text-muted text-size-small">$37,578 avg</div> #}
                                                        </div>

                                                        <div id="today-revenue"></div>
                                                    </div>
                                                    <!-- /today's revenue -->
                                                </a>

                                            </div>
                                            <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
                                                <a href="{{ path('perfil_show') }}">
                                                    <!-- Today's revenue -->
                                                    <div class="panel bg-grey-400">
                                                        <div class="panel-body">
                                                            {#
                                                            <div class="heading-elements">
                                                                <ul class="icons-list">
                                                                    <li><a data-action="reload"></a></li>
                                                                </ul>
                                                            </div>
                                                            #}
                                                            <h5 class="no-margin"><i class="icon-user-plus"></i> Mi perfil</h5>

                                                            {# <div class="text-muted text-size-small">$37,578 avg</div> #}
                                                        </div>

                                                        <div id="today-revenue"></div>
                                                    </div>
                                                    <!-- /today's revenue -->
                                                </a>

                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                </div>
                    
				

			</div>
			<!-- /main content -->

		</div>
		<!-- /page content -->

	</div>
	<!-- /page container -->
{% endblock %}

{% block codejs %}
    <script>
        $(function(){
            
            $('[data-toggle="tooltip"]').tooltip();
            $('.select').select2();
            
            if( $("#datepickerSimple").size() == 1 )
            {
                
                //$(".ui-datepicker-year").select2();
                $.datepicker.regional['es'] = {
                   closeText: 'Cerrar',
                   prevText: '< Ant',
                   nextText: 'Sig >',
                   currentText: 'Hoy',
                   monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
                   monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
                   dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
                   dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
                   dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá'],
                   weekHeader: 'Sm',
                   dateFormat: 'yy-mm-dd',
                   firstDay: 1,
                   isRTL: false,
                   showMonthAfterYear: false,
                   yearSuffix: ''
                };
                $.datepicker.setDefaults($.datepicker.regional['es']);               
                $( "#datepickerSimple" ).datepicker({
                    onSelect: function (dateText, inst) {
                        
                        {% if roles.3 is defined %}
                          var userId =  $("#doctorsList").val();
                          //alert(userId);
                          if(userId == "")
                          {
                                $.alert({
                                    icon: 'fa fa-remove',
                                    title: 'Error!',
                                    content: 'Debe de seleccionar un doctor para ver agenda',
                                    type: 'red',
                                });
                                return false;
                          }
                        {% endif %}
                        
                        var date = dateText;
                        getAppointments(date);
                     }
                });
            }
            
            if( $("body").find("#table_result_appointment").size() == 1 )
            {
                $("body").find("#table_result_appointment").DataTable({
                                "searching": false,
                                "bFilter": false,
                                "bInfo": false,
                                "bLengthChange": false,
                                "pageLength": 10,
                                //"autoWidth": true,
                                "language":{
                                    oPaginate: {
                                        sFirst: "Primero",
                                        sLast: "último",
                                        sNext: "Siguiente",
                                        sPrevious: "Anterior"
                                    },
                                },
                                "order": [[ 1, "asc" ]]
                            });
            }
            
            $("#doctorsList").change(function(){
                var id = $(this).val();
                if(id != "" && id > 0 )
                {
                   var date = "{{ "now"|date("Y-m-d") }}";
                   getAppointments(date);
                }
            });
            
            function capitalize(string){
                //return string.charAt(0).toUpperCase() + string.slice(1);
                if( string != "")
                {    
                    return string.toLowerCase().replace( /\b./g, function(a){ return a.toUpperCase(); } );
                }
                else
                {
                    return "";
                }
            }
            
            function getAppointments(date)
            {
                $("#holder_loading").show();
                
                {% if roles.3 is defined %}
                    var userId =  $("#doctorsList").val();   
                {% else %}
                    var userId = {{ userInfo.usuId }}
                {% endif %}    
                
                $.ajax({
                    type: "post",
                    url: "{{ path('emr_dashboard_appointment') }}",
                    data: { date: date, userId: userId  },
                    error: function (data) {
                        $("#holder_loading").hide();
                        $.confirm({
                            icon: 'fa fa-remove',
                            title: 'Error!',
                            content: 'Ha ocurrido un error al tratar de enviar la petición',
                            type: 'red',
                            typeAnimated: true,
                            buttons: {
                                tryAgain: {
                                    text: 'Intentar de nuevo',
                                    btnClass: 'btn-red',
                                    action: function () {
                                        getAppointments();
                                    }
                                },
                                close: function () {
                                }
                            }
                        });
                    },
                    success: function (data) {
                        $("#holder_loading").hide();
                        if( data.length > 0)
                        {
                            var table = "<table class='table text-nowrap' id='table_result_appointment'><thead><tr><th>Mi Agenda de hoy</th><th>Hora</th><th>Estatus</th></tr></thead><tbody>";
                            for(i=0; i < data.length; i++)
                            {    
                                //var routeEdit = "{{ path('paciente_edit', { 'id': "PLACEHOLDER" }) }}";
                                //routeEdit = routeEdit.replace("PLACEHOLDER", data[i]['pac_id']);
                                            
                                var routeShow = "{{ path('consulta_new',{'id':'HOLDERPACID','cm':'HOLDERAPPOINTMENTID'}) }}";
                                routeShow = routeShow.replace("HOLDERPACID", data[i]['pac_id']);
                                routeShow = routeShow.replace("HOLDERAPPOINTMENTID", data[i]['id']);
                                
                                 var btn_group = "";
                                {#            
                                var btn_group += "<div class='media-left media-middle'>";
                                if( data[i]['pac_id'] != "" )
                                {
                                    
                                    btn_group += "<a href='"+routeShow+"' class='btn bg-primary-400  btn-xs' data-toggle='tooltip' data-placement='top' title='Ir a la Consulta'>";
                                    btn_group += "<span class='letter-iconx'>Procesar</span>";
                                    btn_group += "</a>";
                                    
                                }
                                btn_group += "</div>";
                                #}
                                btn_group += "<div class='media-body'>";
                                btn_group += "<div class='media-heading'>";
                                
                                var n = "";
                                if( data[i]['pac_nombre'] != null)
                                {
                                    n += data[i]['pac_nombre']+" ";
                                }
                                if( data[i]['pac_seg_nombre'] != null)
                                {
                                    n += data[i]['pac_seg_nombre']+" ";
                                }
                                if( data[i]['pac_apellido'] != null)
                                {
                                    n += data[i]['pac_apellido']+" ";
                                }
                                if( data[i]['pac_seg_apellido'] != null)
                                {
                                    n += data[i]['pac_seg_apellido']+" ";
                                }
                                
                                var name = $.trim(n); //data[i]['pac_nombre']+" "+data[i]['pac_seg_nombre']+" "+data[i]['pac_apellido']+" "+data[i]['pac_seg_apellido'];
                                var fullname = capitalize(name);
                                //alert(fullname);
                                {% if roles.3 is defined %}
                                    btn_group += "<span class='letter-icon-title'>";
                                    btn_group += fullname;
                                    btn_group += "</span>";
                                {% else %}
                                    btn_group += "<a href='"+routeShow+"' class='letter-icon-title' data-toggle='tooltip' data-placement='top' title='Procesar Consulta'>";
                                    btn_group += fullname;
                                    btn_group += "</a>";
                                {% endif %}    
                                {#
                                btn_group += "<a href='"+routeShow+"' class='letter-icon-title' data-toggle='tooltip' data-placement='top' title='Procesar Consulta'>";
                                btn_group += data[i]['pac_nombre']+" "+data[i]['pac_seg_nombre']+" "+data[i]['pac_apellido']+" "+data[i]['pac_seg_apellido'];
                                btn_group += "</a>";
                                #}

                                btn_group += "<div class='text-muted text-size-small'><i class='icon-checkmark3 text-size-mini position-left'></i>"; 
                                                                            {# 
                                                                            //Events type
                                                                                //1 = Cita Médica
                                                                                //2 = Evento Personal
                                                                                //3 = Ausente
                                                                                //4 = Receso
                                                                                //5 = Otros
                                                                            #}
                                var eventType = "";                                                                        
                                switch(data[i]['tipo_evento'])
                                {
                                    case "1":
                                        eventType = "Cita Médica";
                                        break;
                                    case "2":
                                        eventType = "Evento Personal";
                                        break;
                                    case "3":
                                        eventType = "Ausente";
                                        break;
                                    case "4":
                                        eventType = "Receso";
                                        break;
                                    default:
                                        eventType = "Otros";
                                }
                                btn_group += eventType;
                                btn_group += "</div>";
                                btn_group += "</div>";
                                
                                            
                                table += "<tr>";
                                table += "<td>"+btn_group+"</td>";
                                table += "<td><span class='text-muted text-size-small'>"+data[i]['start']+"</span></td>";
                                
                                var status = "";
                                status += "<h6 class='text-semibold no-margin'>";
                                if( data[i]['tipo_evento'] == 1 )
                                {     
                                    switch(data[i]['age_estado'])
                                    {
                                        case "p":
                                            status += "Pendiente";
                                            break;
                                        case "a":
                                            status += "Anulada";
                                            break;
                                        case "c":
                                            status += "En curso";
                                            break;
                                        case "t":
                                            status += "Finalizada";
                                            break;   
                                    }
                                }
                                {# 
                                     p=pendiente, a=anulada, c=curso, t=terminada
                                #}
 
                                status += "</h6>";
                                
                                table += "<td>"+status+"</td>";

                                table += "</tr>";
                            }
                            table += "</body></table>";
                        }
                        else
                        {
                            {% if roles.3 is defined %}
                               var doc =   " <strong>"+$("#doctorsList option:selected").html()+"</strong> no tiene registros para la fecha <strong>"+date+"</strong>";
                            {% else %}
                               var doc = " No se han encontrado regístros para la fecha <strong>"+date+"</strong>";
                            {% endif %}    
                            table = "<div class='alert alert-danger alert-styled-left alert-arrow-left alert-component'>"+doc+"  </div>";
                        }
                        $("#result_appointment").html(table);
                        if( $("body").find("#table_result_appointment").size() == 1 )
                        {
                            $("body").find("#table_result_appointment").DataTable({
                                "searching": false,
                                "bFilter": false,
                                "bInfo": false,
                                "bLengthChange": false,
                                "pageLength": 10,
                                //"autoWidth": true,
                                "language":{
                                    oPaginate: {
                                        sFirst: "Primero",
                                        sLast: "último",
                                        sNext: "Siguiente",
                                        sPrevious: "Anterior"
                                    },
                                },
                                "order": [[ 1, "asc" ]]
                            });
                            
                            $('[data-toggle="tooltip"]').tooltip();
                        }
                                    
                    }
                });
            }
        });
    </script>
{% endblock %} 