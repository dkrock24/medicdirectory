{% extends "Layout/base_emr/_clients_base.html.twig" %}

{% block title_page %}
        EMR || Nueva Cita
{% endblock %}

{% block breadcrumb %}
    {{ include('EmrBundle:cita:_breadcrumb.html.twig' )  }}
{% endblock %} 

{% block submenutop %}
    {{ include('EmrBundle:cita:_submenu.html.twig' )  }}
{% endblock %} 

{% block body %}
    <style>
        /*
        #calendar {
		max-width: 900px;
		margin: 0 auto;
        }
        */
    
        #divUserPatient{
            display: none;
            
            
        }

    </style>
   
    <div class="page-header-content">
        <div class="page-title">
            <h4>
                <i class="fa fa-info-circle position-left"></i>
                <span class="text-semibold">Home</span> - Calendario de eventos

                <small class="display-block">Seleccione el horario que desea reservar para el evento</small></h4>
            <a class="heading-elements-toggle"><i class="icon-more"></i></a><a class="heading-elements-toggle"><i class="icon-more"></i></a></div>

        <div class="heading-elements">
            <div class="heading-btn-group">

                <a href="#" class="btn btn-link btn-float has-text"><i class="icon-bars-alt text-primary"></i><span>Statistics</span></a>
                <a href="#" class="btn btn-link btn-float has-text"><i class="icon-calculator text-primary"></i> <span>Invoices</span></a>
                <a href="#" class="btn btn-link btn-float has-text"><i class="icon-calendar5 text-primary"></i> <span>Schedule</span></a>

            </div>
        </div>

    </div>
    {# {{ app.request.query.get("d") }} #}
    <div class="rowx">
        <div class="col-lg-12x">
            <!-- Agenda view -->
				<div class="panel panel-flat">
					<div class="panel-heading">
						<h5 class="panel-title">Calendario</h5>
						<div class="heading-elements">
							<ul class="icons-list">
		                		<li><a data-action="collapse"></a></li>
		                		<li><a data-action="reload"></a></li>
		                		<li><a data-action="close"></a></li>
		                	</ul>
	                	</div>
					</div>
					
					<div class="panel-body">
                        <div class="row">
                            <div class="col-lg-3 col-md-4 col-sm-12">
                                <div class="alert alert-info alert-styled-left alert-arrow-left alert-component">
                                    <i class="fa fa-user-md" aria-hidden="true"></i> Doctores asignados
                                </div>
                                <div>
                                    
                                    {% if doctorList|length > 0 %}
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Doctor</th>
                                                    <th>Acción</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                            {% for doctor in doctorList %}
                                                <tr id="d_{{ doctor.usu_id }}">
                                                    <td>{{ doctor.usu_nombre }}</td>
                                                    <td>
                                                        <a href="" class="btn btn-primary btn-sm" data-popup="tooltip" title="" data-original-title="Mandar email"><i class="fa fa-envelope-o" aria-hidden="true"></i> </a>
                                                        <a href="{{ path('agenda_new') }}?d={{ doctor.usu_id}}" class="btn btn-success btn-sm" data-popup="tooltip" title="" data-original-title="Ver Agenda"><i class="fa fa-calendar"></i></a>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>    
                                    {% else %}    
                                        <div class="alert alert-danger"><i class="fa fa-times-circle" aria-hidden="true"></i> No hay doctores asociados a este establecimiento</div>
                                    {% endif %}    
                                </div>
                            </div>
                            <div class="col-lg-9 col-md-8 col-sm-12">
                                <div class="alert alert-info alert-styled-left alert-arrow-left alert-component">
                                    Calendario de eventos <span id="labelDoctorName"></span>
                                </div>
                                <div class="row">
                                    <div class="col-lg-8 col-md-8">
                                        <div id="calendar"></div>
                                    </div>
                                    <div class="col-lg-4 col-md-4">
                                        <div class="alert alert-info ">
                                            Tipos de eventos
                                        </div>
                                        <div>
                                            <div >
                                                <span style="background:#0E77AE; width: 25px; height: 25px; display:inline-block; float: left;"></span>
                                                <span style="line-height: 25px; float: left; padding-left: 10px"> Cita médica</span>
                                                <div style="clear:both; margin-bottom: 10px;" ></div>
                                            </div>
                                            <div>
                                                <span style="background:#26A69A; width: 25px; height: 25px; display:inline-block; float: left;"></span>
                                                <span style="line-height: 25px; float: left; padding-left: 10px"> Ausente</span>
                                                <div style="clear:both; margin-bottom: 10px;" ></div>
                                            </div>
                                            <div>
                                                <span style="background:#3a3a3a; width: 25px; height: 25px; display:inline-block; float: left;"></span>
                                                <span style="line-height: 25px; float: left; padding-left: 10px"> Tiempo de Comida</span>
                                                <div style="clear:both; margin-bottom: 10px;" ></div>
                                            </div>
                                            <div>
                                                <span style="background:#FF7043; width: 25px; height: 25px; display:inline-block; float: left;"></span> 
                                                <span style="line-height: 25px; float: left; padding-left: 10px"> Otros</span>
                                                <div style="clear:both; margin-bottom: 10px;" ></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
					</div>
				</div>
				<!-- agenda view -->
        </div>
        <div class="">
           {# {{ include('EmrBundle:paciente:_search.html.twig' )  }}    #}   
        </div>
    </div>
            
    <!-- Modal -->
    <!---
    <div class="modal fade" id="calendarModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">Modal title</h4>
          </div>
          <div class="modal-body">
              <div id="modalTitle"></div>
              <div id="modalByWhen"></div>
              <div id="eventId"></div>
              
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="save">Save changes</button>
          </div>
        </div>
      </div>
    </div>  
    -->
    <!-- Modal to Event Details -->

<!-- Modal  to Add Event -->
   
<div id="createEventModal" class="modal fade" role="dialog">

    <div class="modal-dialog">
    <!--<div class="modal-dialog modal-lg"> -->
        <!-- Modal content-->

        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Agregar evento</h4>
            </div>

            <div class="modal-body">
                
                <div class="row">
                    <div class="col-lg-6">
                        <div class="control-group">
                            <label class="control-label" for="eventType">Seleccionar tipo de evento:</label>
                            <select class="form-control" id="eventType">
                                <option value="1">Cita Médica</option>
                                {% if "6" in userRoles|keys %} {# 6 = role Medico #}
                                    <option value="2">Evento Personal</option>
                                    <option value="3">Ausente</option>
                                    <option value="4">Tiempo de Comida</option>
                                    <option value="5">Otros</option>
                                {% endif %} 
                            </select>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div id="divRoom">
                            <label class="control-label" for="room"># Consultorio:</label>
                            <input type="text" value="" placeholder="# Consultorio" class="form-control" id="room">
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <div class ="form-group" id="divSearchPatient">
                    <div class="field">
                        <label class="control-label" for="title" id="titlePatient">Añadir paciente:</label>
                        <form id="form_search_patients">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Nombre o DUI" id="input_search_patients" autocomplete="off">
                                <span class="input-group-btn">
                                    <button class="btn bg-slate" type="submit" id="btn_search_patients"><i class="glyphicon glyphicon-search"></i></button>
                                </span>
                            </div><!-- /input-group -->
                        </form>
                        
                         <input type="hidden" value="" id="setUserAppointmentId" >
                         <div id="divUserPatient">
                            <div class="input-group">
                                <span class="input-group-addon"><i class="fa fa-user"></i></span>
                                <input type="text" value="" id="setUserAppointmentName" class="form-control" disabled="disabled">
                            </div>
                         </div>
                        <div id="result_search_patients"></div>
                    </div>
                </div>
                
                <div class ="form-group">
                    <label class="control-label" for="title">Doctor:</label>
                    <div class="input-group">
                        <span class="input-group-addon"><i class="fa fa-user-md"></i></span>
                        <input class="form-control" id="doctorId" name="doctorId" placeholder="Doctor" type="hidden" value="">
                        <input class="form-control" id="doctorName" name="doctorName" placeholder="Doctor" type="text" value="" disabled="disabled">   
                        
                    </div>
                </div>
                <div class ="form-group">
                    <div class="field desc">
                         <label class="control-label" for="title">Nota:</label>
                        <input class="form-control" id="title" name="title" placeholder="Nota:" type="text" value="">
                    </div>
                </div>

                <input type="hidden" id="startTime"/>
                <input type="hidden" id="endTime"/>

                <div class="control-group">
                    <label class="control-label" for="when">Cuando:</label>
                    <div class="alert alert-info alert-styled-left alert-arrow-left alert-component"><div class="controls controls-row" id="when" style="margin-top:5px;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" data-dismiss="modal" aria-hidden="true">Cerrar</button>
                <button type="submit" class="btn btn-primary" id="submitButton">Guardar</button>
            </div>
        </div>
    </div>
</div>



<!-- Modal to Event Details -->

<div id="calendarModal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Detalles de la cita</h4>
            </div>

            <div id="modalBody" class="modal-body">
                <h4 id="modalTitle" class="modal-title"></h4>
                <div id="modalWhen" style="margin-top:5px;"></div>
            </div>

            <input type="hidden" id="eventID"/>
            <div class="modal-footer">
                <button class="btn"  data-dismiss="modal" aria-hidden="true">Cerrar</button>
                <button type="submit" class="btn btn-danger" id="deleteButton">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<!--Modal-->

<!--Modal-->
{% endblock %}


{% block codejs %}
    <script>
        $(document).on("ready", function(){
            
            var d = "{{ app.request.query.get("d") }}";
            if( d != "")
            {
                var doctor = $("body").find("#d_"+d).find("td").eq(0).text();
                $("#doctorName").val(doctor);
                $("#doctorId").val(d);
                $("#labelDoctorName").html(" (<strong>"+doctor+"</strong>) ");
                
            }
            //$('[data-toggle="tooltip"]').tooltip();
            
            // Add events
            // ------------------------------
            var initialLocaleCode = 'es-do';

            // Event colors
            var eventColors = [
                {
                    title: 'All Day Event',
                    start: '2014-11-01',
                        color: '#EF5350'
                },
                {
                    title: 'Long Event',
                    start: '2017-04-30',
                    end: '2017-04-30',
                    color: '#26A69A'
                },
                {
                    //id: 999,
                    title: 'Repeating Event x',
                    start: '2017-04-28T16:00:00',
                    color: '#26A69A'
                },
                {
                    id: 999,
                    title: 'Repeating Event y',
                    start: '2014-11-16T16:00:00',
                    color: '#5C6BC0'
                },
                {
                    title: 'Conference',
                    start: '2014-11-11',
                    end: '2014-11-13',
                    color: '#546E7A'
                },
                {
                    title: 'Meeting',
                    start: '2014-11-12T10:30:00',
                    end: '2014-11-12T12:30:00',
                    color: '#546E7A'
                },
                {
                    title: 'Birthday Party',
					start: '2014-11-13T07:00:00',
					color: '#546E7A'
                },
				{
                    title: 'Click for Google',
					url: 'http://google.com/',
					start: '2014-11-28',
					color: '#FF7043'
				}
			];

            // Initialization
            // ------------------------------
            // Agenda view
            if( $("#calendar").size() == 1 )
            {
                $('#calendar').fullCalendar({
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'month,agendaWeek,agendaDay'
                },
                //default: 30,
                locale: initialLocaleCode,
                //defaultDate: '2017-04-29',
                defaultView: 'agendaWeek',
                editable: true,
                eventLimit: true, // allow "more" link when too many events
                navLinks: true, // can click day/week names to navigate views
                selectable: true,
                selectHelper: true,
                //events: eventColors,
                events: "{{ path('agenda_valida') }}?view=1",
                eventClick:  function(event, jsEvent, view) {  // when some one click on any event

                    endtime = $.fullCalendar.moment(event.end).format("h:mm");
                    starttime = $.fullCalendar.moment(event.start).format("dddd, MMMM Do YYYY, h:mm");
                    var mywhen = starttime + " – " + endtime;
                    $("#modalTitle").html(event.title);
                    $("#modalWhen").text(mywhen);
                    $("#eventID").val(event.id);
                    $("#calendarModal").modal({backdrop: 'static', keyboard: false});
                },
                select: function(start, end, jsEvent) {  // click on empty time slot
                    endtime = $.fullCalendar.moment(end).format("h:mm");
                    starttime = $.fullCalendar.moment(start).format("dddd, MMMM Do YYYY, h:mm");
                    var mywhen = starttime + " – " + endtime;
                    start = moment(start).format();
                    end = moment(end).format();
                    $("#createEventModal #startTime").val(start);
                    $("#createEventModal #endTime").val(end);
                    $("#createEventModal #when").text(mywhen);
                    //$("#createEventModal").modal("toggle");
                    $("#createEventModal").modal({backdrop: 'static', keyboard: false});

                },
                eventDrop: function(event, delta){ // event drag and drop
                    $.ajax({
                        url: "{{ path('agenda_valida')}}",
                        data: "action=update&title="+event.title+"&start="+moment(event.start).format()+"&end="+moment(event.end).format()+"&id="+event.id ,
                        type: "POST",
                        success: function(json) {
                            //alert(json);
                        }
                    });
                },
                eventResize: function(event) {  // resize to increase or decrease time of event
                    $.ajax({
                        url: "{{ path('agenda_valida') }}",
                        data: "action=update&title="+event.title+"&start="+moment(event.start).format()+"&end="+moment(event.end).format()+"&id="+event.id,
                        type: "POST",
                        success: function(json) {
                            //alert(json);
                        }
                    });

            }
                /*
                select: function(start, end) {
                   
                    var title = prompt('Event Title:');
                    var eventData;
                    if (title) {
                        eventData = {
                            title: title,
                            start: start,
                            end: end
                        };
                        $('#calendar').fullCalendar('renderEvent', eventData, true); // stick? = true
                    }
                    $('#calendar').fullCalendar('unselect');
                    
                },
                */
                
            });
            }
            
            $("#submitButton").on("click", function(e){ // add event submit
                // We don"t want this to act as a link so cancel the link action
                e.preventDefault();
                doSubmit(); // send to form submit function
            });

       

            $("#deleteButton").on("click", function(e){ // delete event clicked
                // We don"t want this to act as a link so cancel the link action
                e.preventDefault();
                doDelete(); //send data to delete function
            });

       

        function doDelete(){  // delete event 

           $("#calendarModal").modal("hide");
           var eventID = $("#eventID").val();
           $.ajax({
               url: "{{ path('agenda_valida') }}",
               data: "action=delete&id="+eventID,
               type: "POST",
               success: function(json) {
                   if(json == 1)

                        $("#calendar").fullCalendar("removeEvents",eventID);

                   else

                        return false;
               }
           });

       }

        function doSubmit(){ // add event

           $("#createEventModal").modal("hide");

           var title = $("#title").val();

           var startTime = $("#startTime").val();

           var endTime = $("#endTime").val();

           

           $.ajax({

               url: "{{ path('agenda_valida') }}",

               data: "action=add&title="+title+"&start="+startTime+"&end="+endTime,

               type: "POST",

               success: function(json) {

                   $("#calendar").fullCalendar("renderEvent",
                   {
                       id: json.id,
                       title: title,
                       start: startTime,
                       end: endTime,
                   },

                   true);

               },
               error: function(json){
                  $("#calendar").fullCalendar("renderEvent",
                   {
                       id: json.id,
                       title: title,
                       start: startTime,
                       end: endTime,
                   },

                   true);
               }
           });
       }
            

        $("#eventType").change(function(){
            if( $(this).val() != 1 ) //1 = Cita medica
            {
                $("#divRoom, #divSearchPatient").hide();
                $("#setUserAppointmentId, #setUserAppointmentName").val("");
                $("#result_search_patients").empty();
            }
            else
            {
                $("#divRoom, #divSearchPatient").show();
                //console.log("No");
            }
        });
        
        
        //======================================================================
        //Search patient
        //======================================================================
        $("#form_search_patients").submit(function(e){
            e.preventDefault();
            searchPatients();
            return false;
        });
                    
                    
        function searchPatients()
        {
            var search = $("#input_search_patients").val();
            if( $.trim(search) == "" )
            {
                //var infoError = (data);
                $.alert({
                    icon: 'glyphicon glyphicon-exclamation-sign',
                    title: 'Info!',
                    content: 'El campo de la búsqueda no puede estar vacio',
                    type: 'blue',
                    typeAnimated: true,
                });
                return false;
            }
            $("#holder_loading").show();
            $.ajax({
                type: "post",
                url: "{{ path('paciente_search') }}",
                data: { search: search },
                error: function (data) {
                    $("#holder_loading").hide();
                    $.confirm({
                        icon: 'fa fa-remove',
                        title: 'Error!',
                        content: 'Ha ocurrido un error al tratar de enviar la petición',
                        type: 'red',
                        typeAnimated: true,
                        buttons: {
                            tryAgain: {
                                text: 'Intentar de nuevo',
                                btnClass: 'btn-red',
                                action: function () {
                                    searchPatients();
                                }
                            },
                            close: function () {
                            }
                        }
                    });
                },
                success: function (data) {
                    $("#holder_loading").hide();
                    if( data.length > 0)
                    {
                        var table = "<table class='table table-striped' id='table_result_patients'><thead><tr><th>Nombre</th><th>DUI</th><th></th></tr></thead><tbody>";
                        for(i=0; i < data.length; i++)
                        {
                            var routeEdit = "{{ path('paciente_edit', { 'id': "PLACEHOLDER" }) }}";
                            routeEdit = routeEdit.replace("PLACEHOLDER", data[i]['pac_id']);
                            var routeShow = "{{ path('paciente_show', { 'id': "PLACEHOLDER" }) }}";
                            routeShow = routeShow.replace("PLACEHOLDER", data[i]['pac_id']);
                                            
                            var btn_group = "<div class='btn-group' role='group'>";
                            btn_group += "<button type='button' class='label bg-danger-400 dropdown-toggle' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false'>";
                            btn_group += "Acción";
                            btn_group += "<span class='caret'></span>";
                            btn_group += "</button>";
                            btn_group += "<ul class='dropdown-menu dropdown-menu-right'>";
                            btn_group += "<li><a href='#' class='addUserAppointment noActionLink' data-user='"+data[i]['pac_id']+"'><i class='fa fa-calendar-check-o'></i> Añadir Cita</a></li>";
                            btn_group += "<li class='divider'></li>";
                            btn_group += "<li><a href='"+routeShow+"'><i class='fa fa-folder-open'></i> Ver</a></li>";
                            btn_group += "<li><a href='"+routeEdit+"'><i class='fa fa-edit'></i> Editar</a></li>";
                            btn_group += "<li class='divider'></li>";
                            btn_group += "<li><a href='#' class='noActionLink'><i class='fa fa-minus-square'></i> Cerrar menú</a></li>";
                            btn_group += "</ul>";
                            btn_group += "</div>";
                                            
                            table += "<tr>";
                            table += "<td>"+data[i]['fullname']+"</td>";
                            table += "<td>"+data[i]['dui']+"</td>";
                            table += "<td>"+btn_group+"</td>";
                            table += "</tr>";
                        }
                        table += "</body></table>";
                    }
                    else
                    {
                        table = "<br><div class='alert alert-danger'><i class='glyphicon glyphicon-exclamation-sign'></i> No se han encontrado regístros</div>";
                    }
                    $("#result_search_patients").html(table);
                    if( $("body").find("#table_result_patients").size() == 1 )
                    {
                        $("body").find("#table_result_patients").DataTable({
                            "searching": false,
                            "bFilter": false,
                            "bInfo": false,
                            "bLengthChange": false,
                            "pageLength": 5,
                            "language":{
                                oPaginate: {
                                    sFirst: "Primero",
                                    sLast: "último",
                                    sNext: "Siguiente",
                                    sPrevious: "Anterior"
                                },
                            },
                            "order": [[ 0, "desc" ]]
                        });
                    }
                }
            });
        }
        
        setUserAppointment();
        function setUserAppointment()
        {
            var txt = $("#titlePatient").text();
            $("body").on("click",".noActionLink", function(e){
                e.preventDefault();

                if( $(this).hasClass("addUserAppointment") )
                {
                   var id =  $( this ).data( "user" );
                   $("#setUserAppointmentId").val(id);
                   
                   var name = $( this ).closest("tr").find("td").eq(0).text();
                    $("#setUserAppointmentName").val(name);
                    
                    $("#result_search_patients").empty();
                    $("#titlePatient").text("Nombre del paciente:");
                    
                    $("#form_search_patients").hide();
                    
                    $("#divUserPatient").show();
                    
                    if( $("body").find("#newSearch").size() == 0 )
                    {
                        $( "#result_search_patients" ).after( "<p class='text-right' id='newSearch'><a href='#'>Nueva busqueda</a></p>" );
                    }
                }
            });
            
            $("body").on("click","#newSearch a", function(e){
                e.preventDefault();
                $("#setUserAppointmentId, #setUserAppointmentName, #input_search_patients").val("");
                $("#divUserPatient").hide();
                
                $("#form_search_patients").show();
                $("#titlePatient").text(txt);   
                
                $("#newSearch").remove();
            });
        }
        
        function setModalMaxHeight(element) {
            this.$element     = $(element);  
            this.$content     = this.$element.find('.modal-content');
            var borderWidth   = this.$content.outerHeight() - this.$content.innerHeight();
            var dialogMargin  = $(window).width() < 768 ? 20 : 60;
            var contentHeight = $(window).height() - (dialogMargin + borderWidth);
            var headerHeight  = this.$element.find('.modal-header').outerHeight() || 0;
            var footerHeight  = this.$element.find('.modal-footer').outerHeight() || 0;
            var maxHeight     = contentHeight - (headerHeight + footerHeight);

            this.$content.css({
                'overflow': 'hidden'
            });

            this.$element
              .find('.modal-body').css({
                'max-height': maxHeight,
                'overflow-y': 'auto'
            });
        }

        $('.modal').on('show.bs.modal', function() {
            $(this).show();
            setModalMaxHeight(this);
        });

        $(window).resize(function() {
            if ($('.modal.in').length != 0) {
              setModalMaxHeight($('.modal.in'));
            }
        });
            
    });
               
                        
    </script>
{% endblock %}    

