{% extends "Layout/base_emr/_clients_base.html.twig" %}


{% block title_page %}
    EMR || Nueva Consulta
{% endblock %}

{% block breadcrumb %}
    {{ include('EmrBundle:consulta:_breadcrumb.html.twig' )  }}
{% endblock %} 

{% block submenutop %}
    {{ include('EmrBundle:consulta:_submenu.html.twig' )  }}
{% endblock %} 

{% block body %}
    <style>
        /*
        #calendar {
                max-width: 900px;
                margin: 0 auto;
        }
        */

        #divUserPatient{
            display: none;

        }
        .detail-patient label{
            display:inline-block;
            width: 80px;
            font-weight: 500;
        }
        
    </style>
    <script src="{{ asset('bundles/admin/add-on/Countdown-Stopwatch/jquery.timer.js') }}"></script>
    {# <script src="{{ asset('bundles/admin/add-on/Countdown-Stopwatch/res/demo.js') }}"></script> #}
    <script>
        var Example1 = new (function() {
            var $stopwatch, // Stopwatch element on the page
                incrementTime = 70, // Timer speed in milliseconds
                //currentTime = 180000, // Current time in hundredths of a second // 3200 = 32 segundos, 1000 = 10 segundos
                currentTime = {{ currentMilisecundsDiff }}, // Current time in hundredths of a second // 3200 = 32 segundos, 1000 = 10 segundos
                updateTimer = function() {
                    $stopwatch.html(formatTime(currentTime));
                    currentTime += incrementTime / 10;
                    if (currentTime == 50) {
                        //alert("zzz");
                        //Example1.Timer.stop();
                        timerComplete();
                        //Example1.resetCountdown();
                        //return;
                    }
                },
                timerComplete = function() {
                    //alert('Example 2: Countdown timer complete!');
                },
                init = function() {
                    $stopwatch = $('#stopwatch');
                    Example1.Timer = $.timer(updateTimer, incrementTime, false);
                };
            this.resetStopwatch = function() {
                currentTime = 0;
                this.Timer.stop().once();
            };
            $(init);
         });
         // Common functions
        function pad(number, length) {
            var str = '' + number;
            while (str.length < length) {str = '0' + str;}
            return str;
        }
        function formatTime(time) {
            var min = parseInt(time / 6000),
                sec = parseInt(time / 100) - (min * 60),
                hundredths = pad(time - (sec * 100) - (min * 6000), 2);
            return (min > 0 ? pad(min, 2) : "00") + ":" + pad(sec, 2) + ":" + hundredths;
        }
    </script>
    <div class="page-header-content">
        
        <div class="page-title">
				<h4>
					<a href="{{ path('emr_dashboard') }}">
                <i class="icon-arrow-left52 position-left"></i>
                <span class="text-semibold">Dashboard</span></a> - Consulta Médica
					<small class="display-block">Formulario de consulta del paciente</small>
				</h4>
		</div>
        
                
        <div class="heading-elements">
            <div class="heading-btn-group">
                
                {#
                <a href="#" class="btn btn-link btn-float has-text"><i class="icon-bars-alt text-primary"></i><span>Statistics</span></a>
                <a href="#" class="btn btn-link btn-float has-text"><i class="icon-calculator text-primary"></i> <span>Siguiente Consulta</span></a>
                #}
                
                <a href="{{ path('agenda_new') }}?d={{ app.user.usuId }}" class="btn btn-link btn-float has-text"><i class="icon-calendar5 text-primary"></i> <span>Mi Agenda</span></a>

            </div>
        </div>
                
    </div>


    {# {{ app.request.query.get("d") }} #}
    {# <div class="panel panel-flat" style="background: #f1f3f2">#}
    <div class="panel panel-flat" style="">
        <div class="panel-body">
            <div class="row">
                <div class="col-lg-3 col-md-4 col-sm-4 col-xs-12"> <!-- col-lg-3 col-md-4 col-sm-4 col-xs-12 -->
                    <div class="panel panel-info">
                        <div class="panel-heading">
                            <h6 class="panel-title">Histórico de citas del paciente<a class="heading-elements-toggle"><i class="icon-more"></i></a></h6>
                            <div class="heading-elements">
                                <ul class="icons-list">
                                    <li><a data-action="collapse"></a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="panel-body" style="padding-bottom: 10px;">
                            
                            <p>Consultas recibidas: <span class="badge badge-flat border-grey text-grey-600"> {{ historialDetail.processed }}</span></p>
                            <p>Consultas Pendientes: <span class="badge badge-flat border-grey text-grey-600" id="pendingAppointment"> {{ historialDetail.pending }}</span></p>
                            <p>Consultas Canceladas: <span class="badge badge-flat border-grey text-grey-600"> {{ historialDetail.cancelated }}</span></p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-9 col-md-8 col-sm-8 col-xs-12">
                    <div class="panel panel-info">
                        <div class="panel-heading">
                            <h6 class="panel-title">Ficha de identificación<a class="heading-elements-toggle"><i class="icon-more"></i></a></h6>
                            <div class="heading-elements">
                                <ul class="icons-list">
                                    <li><a data-action="collapse"></a></li>
                                    {#
                                    <li><a data-action="reload"></a></li>
                                    <li><a data-action="close"></a></li>
                                    #}
                                </ul>
                            </div>
                        </div>

                        <div class="panel-body">
                            <div class="row">
                                <div class="col-lg-12 col-md-12 col-sm-12">
                                    <div class="ficha">
                                        {#
                                        <div class="alert alert-info alert-styled-left alert-arrow-left alert-component">
                                            Paciente
                                        </div>
                                        #}
                                        <div class="row">
                                            <div class="col-lg-7 col-md-7 col-sm-12">
                                                
                                                <div style="float: left; max-width: 100px;">
                                                    {% if  patient[0].pacFoto is defined and patient[0].pacFoto != "" %}
                                                    <div style="text-align:center;"><img src="{{ asset("uploads/pacientes/"~paciente.pacFoto) }}" class="img-thumbnailx" style="max-width:85% "></div>
                                                    {% else %}
                                                        {% if patient[0].pacGenero is defined and patient[0].pacGenero|lower  == "m" %}
                                                        <div  style="text-align:center"><img src="{{ asset('bundles/admin/img/man.png') }}" class="img-thumbnailx" style="max-width:80% "></div>
                                                        {% else %}
                                                        <div  style="text-align:center"><img src="{{ asset('bundles/admin/img/girl.png') }}" class="img-thumbnailx" style="max-width:80% "></div>
                                                        {% endif %}

                                                    {% endif %}
                                                </div>
                                                
                                                
                                                <div class="detail-patient">
                                                    <label>Nombre:</label>
                                                    <span>
                                                        {{ patient[0].pacNombre }} {{ patient[0].pacSegNombre }} {{ patient[0].pacApellido }} {{ patient[0].pacSegApellido }}
                                                    </span>
                                                </div>
                                                <div class="detail-patient">
                                                    <label>Edad:</label><span>{{ age }}</span>
                                                </div>
                                                <div class="detail-patient">
                                                    <label>Expediente:</label><span>Ver detalle completo</span>
                                                </div>
                                            </div>
                                            <div class="col-lg-5 col-md-5 col-sm-12">
                                                
                                            </div>    
                                            {#    
                                            <div class="col-lg-2 col-md-3 col-sm-12">
                                                {% if  paciente.pacFoto is defined and paciente.pacFoto != "" %}
                                                    <div style="text-align:center;"><img src="{{ asset("uploads/pacientes/"~paciente.pacFoto) }}" class="img-thumbnailx" style="max-width:85% "></div>
                                                    {% else %}
                                                        {% if paciente.pacGenero is defined and paciente.pacGenero|lower  == "m" %}
                                                        <div  style="text-align:center"><img src="{{ asset('bundles/admin/img/man.png') }}" class="img-thumbnailx" style="max-width:80% "></div>
                                                        {% else %}
                                                        <div  style="text-align:center"><img src="{{ asset('bundles/admin/img/girl.png') }}" class="img-thumbnailx" style="max-width:80% "></div>
                                                        {% endif %}

                                                {% endif %}
                                            </div>
                                            #}
                                        </div>


                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-6 col-sm-12 ">
                                    {#
                                    <div class="alert alert-info alert-styled-left alert-arrow-left alert-component">
                                        Consultas anteriores
                                    </div>
                                    #}
                                    {#
                                    <div>
                                       
                                        {% if historical|length > 0 %}
                                            <table class="table table-striped">
                                                <thead>
                                                    <tr>
                                                        <th>Fecha</th>
                                                        <th>Estado</th>
                                                        <th>Acción</th>
                                                    </tr>
                                                </thead>
                                                <tbody>        
                                            {% for data in historical %}
                                                
                                                    
                                                        <tr>
                                                            <td>{{ data.start }}</td>
                                                            <td>
                                                                {% if data.age_estado == "p" %}
                                                                                Pendiente
                                                                {% elseif data.age_estado == "a" %}
                                                                                Anulada
                                                                {% elseif data.age_estado == "c" %}
                                                                                En curso
                                                                {% elseif data.age_estado == "t" %}
                                                                                Finalizada
                                                                {% endif %}
                                                            </td>
                                                            <td><button class="btn btn-default btn-xs"> <i class="fa fa-search" aria-hidden="true"></i> Vista previa</button></td>
                                                        </tr>
                                                    
                                            {% endfor %} 
                                                </tbody>
                                            </table>
                                        {% else %}
                                            Este paciente no tiene historico de citas aún
                                        {% endif %}    
                                    </div>
                                    #}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <hr>
            
            <div class="row">
                <div class="col-lg-3 col-md-4 ">
                    <div class="panel panel-info" id="appointmentControl">
                        <div class="panel-heading">
                            <h6 class="panel-title">Cronómetro de consulta<a class="heading-elements-toggle"><i class="icon-more"></i></a></h6>
                            <div class="heading-elements">
                                <ul class="icons-list">
                                    <li><a data-action="collapse"></a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="panel-body text-center">
                            
                                {% if statusAppointment == "p" or statusAppointment == "c" %}
                                <div class="timer-time timer-container" >    
                                <h6>Tiempo agendado:
                                    {{ hours }}
                                    {% if hours > 1 or hours == 0 %}
                                        Horas
                                    {% else %}
                                        Hora
                                    {% endif %}
                                    Con {{ minutes }}
                                    {% if minutes > 1 or minutes == 0 %}
                                        Minutos
                                    {% else %}
                                        Minuto
                                    {% endif %}    
                                </h6>
                                <span id="stopwatch">00:00:00</span>
                                <p>
                                    {# <input class='btn btn-primary' id="btn_start_appointment" type='button' value='Iniciar/Pausar' onclick='Example1.Timer.toggle();' /> #}
                                    {% if currentMilisecundsDiff == 0 %}
                                        <input class='btn btn-primary' id="btn_start_appointment" type='button' value='Iniciar Consulta' onclick='' />
                                    {% else %} 
                                        <input class='btn btn-primary' id="btn_end_appointment" type='button' value='Finalizar Consulta' onclick='Example1.resetStopwatch();'/>
                                    {% endif %}
                                    <input class='btn btn-primary' id="btn_end_appointment" type='button' value='Finalizar Consulta' onclick='Example1.resetStopwatch();' style="display:none" />
                                    
                                </p>
                                </div>
                                {% elseif statusAppointment == "t" %}
                                    <div class="alert alert-success alert-styled-left alert-arrow-left alert-component">Esta consulta ya ha sido procesada</div>
                                {% else %}
                                    <div class="alert alert-danger alert-styled-left alert-arrow-left alert-component">Esta consulta ya no está disponible para procesar</div>
                                {% endif %}    
                                
                                
                                
                                <input type="hidden" id="app_status" value="">
                                <input type="hidden" id="currentMilisecundsDiff" value="{{ currentMilisecundsDiff }}">
                            
                            <hr>    
                            <div class="btn-group">
                                    {#<button class="btn btn-success" data-toggle="modal" data-target="#newApponintment" data-backdrop="static" data-keyboard="false" style="margin-bottom: 10px;"><i class="fa fa-calendar" aria-hidden="true" ></i> Agendar nueva consulta</button>#}
                                    <button class="btn btn-success" id="btn_appointment" style="margin-bottom: 10px;"><i class="fa fa-calendar" aria-hidden="true" ></i> Agendar nueva consulta</button>
                                    <button class="btn btn-success" style="margin-bottom: 10px;"><i class="fa fa-address-card-o" aria-hidden="true"></i> Histórico de conultas</button>
                             </div>    
                        </div>
                    </div>
                    
                    {#
                    <div class="panel panel-info panel-collapsed">
                        <div class="panel-heading">
                            <h6 class="panel-title">Programar Nueva Cita<a class="heading-elements-toggle"><i class="icon-more"></i></a></h6>
                            <div class="heading-elements">
                                <ul class="icons-list">
                                    <li><a data-action="collapse"></a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="panel-body" style="">
                           <h5></h5>
                            <div id="datepickerSimple"></div>
                        </div>
                    </div>
                    #}
                </div>
                <div class="col-lg-9 col-md-8">
                    <div class="panel panel-info">
                        <div class="panel-heading">
                            <h6 class="panel-title">Captura de datos del paciente<a class="heading-elements-toggle"><i class="icon-more"></i></a></h6>
                            <div class="heading-elements">
                                <ul class="icons-list">
                                    <li><a data-action="collapse"></a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="panel-body">
                            
                            <div class="row">
                                
                                <div class="col-lg-3">
                                    <div class="alert alpha-teal border-teal alert-styled-left">
                                        Módulos adquiridos <i class="fa fa-hand-o-down" aria-hidden="true"></i>
                                    </div>
                                <!-- Here goes the modules list -->
                                {{ render( controller('EmrBundle:EavModulos:crearMenuModulos', { 'modulos': modulos } ) ) }}
                                </div>
                                <div class="col-lg-9">
                                <!-- end of modules list -->
                                {% if modulos|length > 0 %}
                                    {{ render( controller( 'EmrBundle:EavModulos:crearFormModulo', 
                                        { 'mod_hash': modulos[0]['mod_hash'], 
                                        'usu_id': usu_id, 'pac_id': patient[0].pacId, 'cli_id': cli_id, 'cit_id': cit_id } ) ) 
                                    }}
                                {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
                               
             
    {{ include('EmrBundle:consulta:_modals.html.twig' )  }}                           
{% endblock %}


{% block codejs %}
    <script>
        $(document).on("ready", function () {
            var currentMilisecundsDiff = {{ currentMilisecundsDiff }};
            if( currentMilisecundsDiff > 0 )
            {
                Example1.Timer.toggle();
                $("#app_status").val("started");
            }
            $("#btn_start_appointment").on("click",function(){
                
               var status = $("#app_status").val();
               if( status == "" )
               {
                   actionAppointement("add");
               }
               else
               {
                   if( status == "started" )
                   {
                       $("#app_status").val("stopped");
                   }
                   else
                   {
                       $("#app_status").val("started");
                   }
                   Example1.Timer.toggle();
                   
               }
                //
            });
            
            $("#btn_end_appointment").on("click",function(){
                actionAppointement("finish");
            });
            
            function actionAppointement(action)
            {
                 $("#holder_loading").show();
                $.ajax({
                    
                    url: "{{ path('consulta_procesa') }}",
                    data: "action="+action+"&cm="+{{ app.request.get("cm") }},
                    type: "POST",
                    success: function(json) {
                        //alert(json);
                        $("#holder_loading").hide();
                        if( json == 1 )
                        {
                            if(action == "add")
                            {    
                                Example1.Timer.toggle();
                                $("#app_status").val("started");
                                $("#btn_start_appointment").remove();
                                $("#btn_end_appointment").show();
                            }
                            else
                            {
                                $("#app_status").val("finshed");
                                Example1.resetStopwatch();
                                
                                $.confirm({
                                    icon: 'fa fa-medkit',
                                    title: 'Ok',
                                    columnClass: 'medium',
                                    content: 'La consulta ha sido finalizada con éxito, desea agendar nueva cita a este paciente?<hr>',
                                    type: 'green',
                                    typeAnimated: true,
                                    buttons: {
                                        tryAppointment: {
                                            text: 'Si, Agendar',
                                            btnClass: 'btn-green btn-sm',
                                            action: function () {
                                                var date = "{{ "now"|date("Y-m-d") }}";
                                                getAppointments(date);
                                                $("#newApponintment").modal({backdrop: 'static', keyboard: false});
                                            }
                                        },
                                        tryDashboard: {
                                            text: 'Ir a Mi dashboard',
                                            btnClass: 'btn-blue btn-sm',
                                            action: function () {
                                                location.href = "{{ path('emr_dashboard') }}";
                                                //getAppointments();
                                            }
                                        },
                                        tryAgenda: {
                                            text: 'Ir a mi agenda',
                                            btnClass: 'btn-default btn-sm',
                                            action: function () {
                                                location.href = "{{ path('agenda_new') }}?d={{ app.user.usuid}}";
                                            }
                                        },    
                                    }
                                });
                            }
                        }
                        else
                        {
                            $.alert({
                                icon: 'fa fa-clock-o',
                                title: 'Error!',
                                content: "<p class=''>Ha ocurrido un error inesperado al intentar iniciar la consulta, si el problema persiste No utilize el cronometro</p>",
                                type: 'red',
                                typeAnimated: true,
                            });
                        }
                        /*
                        $("#title,#room").val("");
                        $.alert({
                            icon: 'fa fa-calendar',
                            title: 'Ok!',
                            content: "<p class=''>Cita creada con éxito</p>",
                            type: 'green',
                            typeAnimated: true,
                        });
                        */

                    },
                    error: function(json){
                       $("#holder_loading").hide(); 
                       $.alert({
                            icon: 'fa fa-clock-o',
                            title: 'Error!',
                            content: "<p class=''>Ha ocurrido un error inesperado al intentar iniciar la consulta</p>",
                            type: 'red',
                            typeAnimated: true,
                        });
                    }
                });
            }
            
            //$(function(window,undefined){

            //var d = "{{ app.request.query.get("d") }}";
            //$(".datepicker").datepicker();
            
            //ui-datepicker-current-day
            /*
            $("#room").on("change  paste", function(){
                console.log("cambio");
            })
            */
            if( $("#modulesList .mod-tab").size() > 0 )
            {
                $("#modulesList .mod-tab").each(function(){
                    var info = $(this).text();;
                    $("#moduleActivated").html("<strong><span class'bg-success text-highlight'>"+info+"</span></strong>");
                    return false;
                });
            } 
            
            
            $("#btn-create-appointment").on("click",function(){
                doAppointment();
            });
            
            if( $("#datepickerSimple").size() == 1 )
            {
                
                //$(".ui-datepicker-year").select2();
                $.datepicker.regional['es'] = {
                   closeText: 'Cerrar',
                   prevText: '< Ant',
                   nextText: 'Sig >',
                   currentText: 'Hoy',
                   monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
                   monthNamesShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
                   dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
                   dayNamesShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
                   dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá'],
                   weekHeader: 'Sm',
                   dateFormat: 'yy-mm-dd',
                   firstDay: 1,
                   isRTL: false,
                   showMonthAfterYear: false,
                   yearSuffix: ''
                };
                $.datepicker.setDefaults($.datepicker.regional['es']);               
                var calendar = $( "#datepickerSimple" ).datepicker({
                    onSelect: function (dateText, inst) {
                        
                        var date = dateText;
                        $("#dateSelected").val(date);
                        getAppointments(date);
                        
                     }
                });
            }
            
            $("#btn_appointment").on("click",function(){
                var dateSelected = $("#dateSelected").val();
                if( dateSelected == "" )
                {
                    var date = "{{ "now"|date("Y-m-d") }}";
                }
                else
                {
                    var date = dateSelected;
                }
                $("#dateSelected").val(date);
                getAppointments(date);
                $("#newApponintment").modal({backdrop: 'static', keyboard: false});
            });
            
            function capitalize(string){
                //return string.charAt(0).toUpperCase() + string.slice(1);
                if( string != "")
                {    
                    return string.toLowerCase().replace( /\b./g, function(a){ return a.toUpperCase(); } );
                }
                else
                {
                    return "";
                }
            }
            
            function getAppointments(date)
            {
                $("#holder_loading").show();
                {#
                {% if roles.3 is defined %}
                    var userId =  $("#doctorsList").val();   
                {% else %}
                    var userId = {{ userInfo.usuId }}
                {% endif %}    
                   #}
                var userId = {{ app.user.usuId }}
                $.ajax({
                    type: "post",
                    url: "{{ path('emr_dashboard_appointment') }}",
                    data: { date: date, userId: userId  },
                    error: function (data) {
                        $("#holder_loading").hide();
                        $.confirm({
                            icon: 'fa fa-remove',
                            title: 'Error!',
                            content: 'Ha ocurrido un error al tratar de enviar la petición',
                            type: 'red',
                            typeAnimated: true,
                            buttons: {
                                tryAgain: {
                                    text: 'Intentar de nuevo',
                                    btnClass: 'btn-red',
                                    action: function () {
                                        getAppointments();
                                    }
                                },
                                close: function () {
                                }
                            }
                        });
                    },
                    success: function (data) {
                        $("#holder_loading").hide();
                        if( data.length > 0)
                        {
                            var table = "<div class='table-responsive'><table class='table text-nowrap' id='table_result_appointment'><thead><tr><th>Tipo de agenda <span id='labelDate'></span></th><th>Hora Inicio</th><th>Hora Fin</th><th>Estatus</th></tr></thead><tbody>";
                            for(i=0; i < data.length; i++)
                            {    
                                //var routeEdit = "{{ path('paciente_edit', { 'id': "PLACEHOLDER" }) }}";
                                //routeEdit = routeEdit.replace("PLACEHOLDER", data[i]['pac_id']);
                                            
                                var routeShow = "{{ path('consulta_new',{'id':'HOLDERPACID','cm':'HOLDERAPPOINTMENTID'}) }}";
                                routeShow = routeShow.replace("HOLDERPACID", data[i]['pac_id']);
                                routeShow = routeShow.replace("HOLDERAPPOINTMENTID", data[i]['id']);
                                
                                 var btn_group = "";
                                {#            
                                var btn_group += "<div class='media-left media-middle'>";
                                if( data[i]['pac_id'] != "" )
                                {
                                    
                                    btn_group += "<a href='"+routeShow+"' class='btn bg-primary-400  btn-xs' data-toggle='tooltip' data-placement='top' title='Ir a la Consulta'>";
                                    btn_group += "<span class='letter-iconx'>Procesar</span>";
                                    btn_group += "</a>";
                                    
                                }
                                btn_group += "</div>";
                                #}
                                btn_group += "<div class='media-body'>";
                                btn_group += "<div class='media-heading'>";
                                
                                var n = "";
                                if( data[i]['pac_nombre'] != null)
                                {
                                    n += data[i]['pac_nombre']+" ";
                                }
                                if( data[i]['pac_seg_nombre'] != null)
                                {
                                    n += data[i]['pac_seg_nombre']+" ";
                                }
                                if( data[i]['pac_apellido'] != null)
                                {
                                    n += data[i]['pac_apellido']+" ";
                                }
                                if( data[i]['pac_seg_apellido'] != null)
                                {
                                    n += data[i]['pac_seg_apellido']+" ";
                                }
                                
                                var name = $.trim(n); //data[i]['pac_nombre']+" "+data[i]['pac_seg_nombre']+" "+data[i]['pac_apellido']+" "+data[i]['pac_seg_apellido'];
                                var fullname = capitalize(name);
                                //alert(fullname);
                                btn_group += "<span class='letter-icon-title'>";
                                btn_group += fullname;
                                btn_group += "</span>";   
                                {#
                                btn_group += "<a href='"+routeShow+"' class='letter-icon-title' data-toggle='tooltip' data-placement='top' title='Procesar Consulta'>";
                                btn_group += data[i]['pac_nombre']+" "+data[i]['pac_seg_nombre']+" "+data[i]['pac_apellido']+" "+data[i]['pac_seg_apellido'];
                                btn_group += "</a>";
                                #}

                                btn_group += "<div class='text-muted text-size-small'><i class='icon-checkmark3 text-size-mini position-left'></i>"; 
                                                                            {# 
                                                                            //Events type
                                                                                //1 = Cita Médica
                                                                                //2 = Evento Personal
                                                                                //3 = Ausente
                                                                                //4 = Receso
                                                                                //5 = Otros
                                                                            #}
                                var eventType = "";                                                                        
                                switch(data[i]['tipo_evento'])
                                {
                                    case "1":
                                        eventType = "Cita Médica";
                                        break;
                                    case "2":
                                        eventType = "Evento Personal";
                                        break;
                                    case "3":
                                        eventType = "Ausente";
                                        break;
                                    case "4":
                                        eventType = "Receso";
                                        break;
                                    default:
                                        eventType = "Otros";
                                }
                                btn_group += eventType;
                                btn_group += "</div>";
                                btn_group += "</div>";
                                
                                            
                                table += "<tr>";
                                table += "<td>"+btn_group+"</td>";
                                var stringDate = data[i]['start'];
                                var stringDate = stringDate.split(" ");
                                var hourType = moment(stringDate[1], ["HH:mm:ss"]).format("hh:mm:ss A");
                                //alert(f);
                                table += "<td><span class='text-muted text-size-small'>"+hourType+"</span></td>";
                                
                                
                                var stringDate = data[i]['end'];
                                var stringDate = stringDate.split(" ");
                                var hourType = moment(stringDate[1], ["HH:mm:ss"]).format("hh:mm:ss A");
                                table += "<td><span class='text-muted text-size-small'>"+hourType+"</span></td>";;
                                
                                var status = "";
                                status += "<span text-muted text-size-small'>";
                                if( data[i]['tipo_evento'] == 1 )
                                {     
                                    switch(data[i]['age_estado'])
                                    {
                                        case "p":
                                            status += "<span class='text-primary'>Pendiente</span>";
                                            break;
                                        case "a":
                                            status += "<span class='text-danger'>Anulada</span>";
                                            break;
                                        case "c":
                                            status += "<span class='text-primary'>En curso</span>";
                                            break;
                                        case "t":
                                            status += "<span class='text-success'>Finalizada</span>";
                                            break;   
                                    }
                                }
                                {# 
                                     p=pendiente, a=anulada, c=curso, t=terminada
                                #}
 
                                status += "</span>";
                                
                                table += "<td>"+status+"</td>";

                                table += "</tr>";
                            }
                            table += "</body></table></div>";
                            
                        }
                        else
                        {
                            var doc = " No se han encontrado regístros para la fecha <strong>"+date+"</strong>";   
                            table = "<div class='alert alert-danger alert-styled-left alert-arrow-left alert-component'>"+doc+"  </div>";
                        }
                        $("#result_appointment").html(table);
                        $("#labelDate").html("("+date+")");
                        if( $("body").find("#table_result_appointment").size() == 1 )
                        {
                            $("body").find("#table_result_appointment").DataTable({
                                "searching": false,
                                "bFilter": false,
                                "bInfo": false,
                                "bLengthChange": false,
                                "pageLength": 5,
                                //"autoWidth": true,
                                "language":{
                                    oPaginate: {
                                        sFirst: "Primero",
                                        sLast: "último",
                                        sNext: "Siguiente",
                                        sPrevious: "Anterior"
                                    },
                                },
                                "order": [[ 1, "desc" ]]
                            });
                            
                            $('[data-toggle="tooltip"]').tooltip();
                        }
                                    
                    }
                });
            }
            
            function doAppointment()
            { // add event

                //$("#createEventModal").modal("hide");
                var title = $("#title").val();
                
                var hoursStart = $("#hoursStart").val();
                var minutesStart = $("#minutesStart").val();
                
                var hoursEnd = $("#hoursEnd").val();
                var minutesEnd = $("#minutesEnd").val();
                var dateSelected = $("#dateSelected").val();
                
                
                
                //2017-07-16T13:30:00
                var startTime = dateSelected+"T"+hoursStart+":"+minutesStart+":00";  //$("#startTime").val();
                var endTime = dateSelected+"T"+hoursEnd+":"+minutesEnd+":00"; //$("#endTime").val();
                var doctorId = {{ app.user.usuId }};//$("#doctorId").val();
                var setUserAppointmentId = {{ patient[0].pacId }};
                var room = $("#room").val();
                var eventType = 1;// 1 = Cita medica
                //alert(startTime+" - "+endTime);
                
                //================================
                //Validate the date 
                //================================
                var fecha1 = moment( dateSelected+" "+hoursStart+":"+minutesStart+":00", "YYYY-MM-DD HH:mm:ss" );
                var fecha2 = moment( dateSelected+" "+hoursEnd+":"+minutesEnd+":00", "YYYY-MM-DD HH:mm:ss" );
                //var fecha1 = moment("2016-09-30 07:30:00", "YYYY-MM-DD HH:mm:ss");
                //var fecha2 = moment("2016-10-03 07:30:00", "YYYY-MM-DD HH:mm:ss");
                var diff = fecha2.diff(fecha1, 'm'); // Diff in minutes
                
                if( diff <= 0 )
                {
                    $.alert({
                            icon: 'fa fa-clock-o',
                            title: 'Error!',
                            content: "<p class=''>La hora fin debe ser mayor a la hora de inicio</p>",
                            type: 'red',
                            typeAnimated: true,
                        });
                        return false;
                }
                //console.log(fecha1+ " | "+ fecha2);
                //console.log(diff);
                //return false;
                
                $("#holder_loading").show();
                $.ajax({

                    url: "{{ path('agenda_valida') }}",
                    data: "action=add&title="+title+"&start="+startTime+"&end="+endTime+"&doctor="+doctorId+"&patient="+setUserAppointmentId+"&room="+room+"&eventType="+eventType,
                    type: "POST",
                    success: function(json) {
                        //alert(json.id);
                        $("#holder_loading").hide();
                        $('#newApponintment').modal('hide');
                        var pending = $("#pendingAppointment");
                        var current = pending.text();
                        var totalPending = parseInt(current)+1;
                        pending.html(totalPending);
                        //$("#pendingAppointment").html();
                        $("#title,#room").val("");
                        $.alert({
                            icon: 'fa fa-calendar',
                            title: 'Ok!',
                            content: "<p class=''>Cita creada con éxito</p>",
                            type: 'green',
                            typeAnimated: true,
                        });

                    },
                    error: function(json){
                       // alert(json.id);
                       $("#holder_loading").hide(); 
                       $.alert({
                            icon: 'fa fa-clock-o',
                            title: 'Error!',
                            content: "<p class=''>Ha ocurrido un error inesperado al intentar crear la cita</p>",
                            type: 'red',
                            typeAnimated: true,
                        });
                    }
                });
            }
            
            $(".mod-tab").click(function(){
                var sTarget = $(this).attr('target');
                var sUrl = "{{ url( 'eav_crear_form_modulo', {'mod_hash': 'modhash', 'usu_id': 'usuid', 'pac_id': 'pacid', 'cli_id': 'cliid', 'cit_id': 'citid'} ) }}";
                sUrl = sUrl.replace( "modhash", sTarget );
                sUrl = sUrl.replace( "usuid", {{ usu_id }} );
                sUrl = sUrl.replace( "pacid", {{ patient[0].pacId }} );
                sUrl = sUrl.replace( "cliid", {{ cli_id }} );
                sUrl = sUrl.replace( "citid", {{ cit_id }} );
                var info = $(this).text();
                //$("#mod-holder").load( sUrl );
                $("#holder_loading").show();
                $.ajax({
                    url: sUrl,
                    //data: "action=delete&id=" + eventID,
                    type: "POST",
                    success: function (data) {
                        $("#holder_loading").hide();
                        var moduleActive = ""//"<div class='alert alert-info alert-styled-left alert-arrow-left alert-component'> Módulo activo: <span id='moduleActivated'></span></div>";
                        $("#mod-holder").html(moduleActive+""+data);
                        
                        $("body").find("#moduleActivated").html("<strong><span class'bg-success text-highlight'>"+info+"</span></strong>");
                        
                        {% if statusAppointment == "p" or statusAppointment == "c" %}
                            $('body').find("form.mod-form :input").each(function(){
                                //console.log("x");
                                $(this).on("change  paste", function(){
                                //$(this).blur( function(){
                                    //if( $(this).attr('data-value') != $(this).val() ){
                                        var tries = 1;
                                        var oInputLabel = $( "label[for='"+$(this).attr('id')+"']" );
                                        oInputLabel.after("<i class='loading-gif'>&nbsp;&nbsp;<img src='{{ asset('bundles/admin/img/ajax-loader.gif') }}'> Guardando..</i>");  
                                        $(".loading-gif").css('color', '#39AED1');
                                        guardarEavForm( $(this), tries );
                                    //}
                                });
                            });
                        {% endif %}
                        
                    },
                    error: function (data) {
                        $.alert({
                            icon: 'fa fa-times',
                            title: 'Error!',
                            content: "<p class=''>No se ha podido cargar el formulario, intente otra vez</p>",
                            type: 'red',
                            typeAnimated: true,
                        });
                        $("#holder_loading").hide();
                        return false;
                    }
                });
            });
            
            function guardarEavForm( input, tries = 0, currentInfo ){
                console.log(currentInfo);
                if( tries < 3 ){
                    var sUrl = "{{ url( 'eav_guardar_valor_form', { 'val_usu_id': 'usuid', 'val_pac_id': 'pacid', 'val_cli_id': 'cliid', 'val_cit_id': 'citid', 'val_camp_id': 'campid', 'value': 'val', } ) }}";
                    sUrl = sUrl.replace( "usuid", {{ usu_id }} );
                    sUrl = sUrl.replace( "pacid", {{ patient[0].pacId }} );
                    sUrl = sUrl.replace( "cliid", {{ cli_id }} );
                    sUrl = sUrl.replace( "citid", {{ cit_id }} ); // <================= NEED TO GET CITA_ID FROM SESSION.
                    var aCampo = input.attr('id').split("_");
                    var camp_id = aCampo[1];
                    sUrl = sUrl.replace( "campid", camp_id );
                    var valor_mandar = null;
                    
                    if( input.val() == ""){
                        valor_mandar = "value_holder";
                    }else{
                        valor_mandar = input.val();
                    }
                    
                    sUrl = sUrl.replace( "val", valor_mandar );

                    
                    $.post( sUrl, function(rdata){
                    }).done(function(  ){
                        $(".loading-gif").css('color', '#3ABC63');
                        $(".loading-gif").html('&nbsp;&nbsp;Listo.').fadeOut(4000);
                    }).fail(function( error ){
                        tries++;
                        $('.loading-gif').replaceWith("<i class='loading-gif'>&nbsp;&nbsp;<img src='{{ asset('bundles/admin/img/ajax-loader.gif') }}'>&nbsp;&nbsp;Tratando de guardar datos nuevamente, por favor espere...</i>");
                        $(".loading-gif").css('color', '#cd4237');
                        guardarEavForm( input, tries );
                    }).always(function(){});
                }else{
                $.alert({
                    title: 'Ha ocurrido un error',
                    type: 'red',
                    content: 'No se han podido guardar los datos del formulario.<br>Confirme si tiene acceso a internet, si el problema persiste contacte a soporte a blbla@blbabla.com',
                    animation: 'zoom',
                    closeAnimation: 'zoom',
                    buttons: {
                        okay: {
                            text: 'Ok',
                            btnClass: 'btn-red'
                        }
                    }
                });
                
                    $('.loading-gif').replaceWith("");
                }
            }
            
            
            {% if statusAppointment == "p" or statusAppointment == "c" %}
                $('body').find("form.mod-form :input").each(function(){
                    //console.log("x");
                    $(this).on("change  paste", function(){
                    //$(this).blur( function(){
                        //if( $(this).attr('data-value') != $(this).val() ){
                            var tries = 1;
                            var oInputLabel = $( "label[for='"+$(this).attr('id')+"']" );
                            oInputLabel.after("<i class='loading-gif'>&nbsp;&nbsp;<img src='{{ asset('bundles/admin/img/ajax-loader.gif') }}'> Guardando..</i>");  
                            $(".loading-gif").css('color', '#39AED1');
                            guardarEavForm( $(this), tries );
                        //}
                    });
                });
                
            {% endif %}
            
            function doDelete() {  // delete event 

                $("#calendarModal").modal("hide");
                var eventID = $("#eventID").val();
                $("#holder_loading").show();
                $.ajax({
                    url: "{{ path('agenda_valida') }}",
                    data: "action=delete&id=" + eventID,
                    type: "POST",
                    success: function (json) {
                        $("#holder_loading").hide();
                        if (json == 1)
                        {
                            $("#calendar").fullCalendar("removeEvents", eventID);
                        } else
                        {
                            return false;
                        }
                    },
                    error: function (json) {
                        $.alert({
                            icon: 'fa fa-times',
                            title: 'Error!',
                            content: "<p class='small'>No se ha podido eliminar el evento</p>",
                            type: 'red',
                            typeAnimated: true,
                        });
                        $("#holder_loading").hide();
                        return false;

                    }
                });

            }




            function searchPatients()
            {
                var search = $("#input_search_patients").val();
                if ($.trim(search) == "")
                {
                    //var infoError = (data);
                    $.alert({
                        icon: 'glyphicon glyphicon-exclamation-sign',
                        title: 'Info!',
                        content: 'El campo de la búsqueda no puede estar vacio',
                        type: 'blue',
                        typeAnimated: true,
                    });
                    return false;
                }
                $("#holder_loading").show();
                $.ajax({
                    type: "post",
                    url: "{{ path('paciente_search') }}",
                    data: {search: search},
                    error: function (data) {
                        $("#holder_loading").hide();
                        $.confirm({
                            icon: 'fa fa-remove',
                            title: 'Error!',
                            content: 'Ha ocurrido un error al tratar de enviar la petición',
                            type: 'red',
                            typeAnimated: true,
                            buttons: {
                                tryAgain: {
                                    text: 'Intentar de nuevo',
                                    btnClass: 'btn-red',
                                    action: function () {
                                        searchPatients();
                                    }
                                },
                                close: function () {
                                }
                            }
                        });
                    },
                    success: function (data) {
                        $("#holder_loading").hide();
                        if (data.length > 0)
                        {
                            var table = "<table class='table table-striped' id='table_result_patients'><thead><tr><th>Nombre</th><th>DUI</th><th></th></tr></thead><tbody>";
                            for (i = 0; i < data.length; i++)
                            {
                                var routeEdit = "{{ path('paciente_edit', { 'id': "PLACEHOLDER" }) }}";
                                routeEdit = routeEdit.replace("PLACEHOLDER", data[i]['pac_id']);
                                var routeShow = "{{ path('paciente_show', { 'id': "PLACEHOLDER" }) }}";
                                routeShow = routeShow.replace("PLACEHOLDER", data[i]['pac_id']);

                                var btn_group = "<div class='btn-group' role='group'>";
                                btn_group += "<button type='button' class='label bg-danger-400 dropdown-toggle' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false'>";
                                btn_group += "Acción";
                                btn_group += "<span class='caret'></span>";
                                btn_group += "</button>";
                                btn_group += "<ul class='dropdown-menu dropdown-menu-right'>";
                                btn_group += "<li><a href='#' class='addUserAppointment noActionLink' data-user='" + data[i]['pac_id'] + "'><i class='fa fa-calendar-check-o'></i> Añadir Cita</a></li>";
                                btn_group += "<li class='divider'></li>";
                                btn_group += "<li><a href='" + routeShow + "'><i class='fa fa-folder-open'></i> Ver</a></li>";
                                btn_group += "<li><a href='" + routeEdit + "'><i class='fa fa-edit'></i> Editar</a></li>";
                                btn_group += "<li class='divider'></li>";
                                btn_group += "<li><a href='#' class='noActionLink'><i class='fa fa-minus-square'></i> Cerrar menú</a></li>";
                                btn_group += "</ul>";
                                btn_group += "</div>";

                                table += "<tr>";
                                table += "<td>" + data[i]['fullname'] + "</td>";
                                table += "<td>" + data[i]['dui'] + "</td>";
                                table += "<td>" + btn_group + "</td>";
                                table += "</tr>";
                            }
                            table += "</body></table>";
                        } else
                        {
                            table = "<br><div class='alert alert-danger'><i class='glyphicon glyphicon-exclamation-sign'></i> No se han encontrado regístros</div>";
                        }
                        $("#result_search_patients").html(table);
                        if ($("body").find("#table_result_patients").size() == 1)
                        {
                            $("body").find("#table_result_patients").DataTable({
                                "searching": false,
                                "bFilter": false,
                                "bInfo": false,
                                "bLengthChange": false,
                                "pageLength": 5,
                                "language": {
                                    oPaginate: {
                                        sFirst: "Primero",
                                        sLast: "último",
                                        sNext: "Siguiente",
                                        sPrevious: "Anterior"
                                    },
                                },
                                "order": [[0, "desc"]]
                            });
                        }
                    }
                });
            }




            function setModalMaxHeight(element) {
                this.$element = $(element);
                this.$content = this.$element.find('.modal-content');
                var borderWidth = this.$content.outerHeight() - this.$content.innerHeight();
                var dialogMargin = $(window).width() < 768 ? 20 : 60;
                var contentHeight = $(window).height() - (dialogMargin + borderWidth);
                var headerHeight = this.$element.find('.modal-header').outerHeight() || 0;
                var footerHeight = this.$element.find('.modal-footer').outerHeight() || 0;
                var maxHeight = contentHeight - (headerHeight + footerHeight);

                this.$content.css({
                    'overflow': 'hidden'
                });

                this.$element
                        .find('.modal-body').css({
                    'max-height': maxHeight,
                    'overflow-y': 'auto'
                });
            }

            $('.modal').on('show.bs.modal', function () {
                $(this).show();
                setModalMaxHeight(this);
            });

            $(window).resize(function () {
                if ($('.modal.in').length != 0) {
                    setModalMaxHeight($('.modal.in'));
                }
            });

        });

        ////////////////////////////////////
        // Determine the correct object to use

    </script>
{% endblock %}    

